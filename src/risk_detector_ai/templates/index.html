{% extends 'base.html' %}

{% block title %}Dashboard - Risk Detector{% endblock %}

{% block content %}
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="text-success">Risk Detector</h2>
        <p class="text-muted mb-0">Analise por jogador — ordenado por Risk Score (maior → menor)</p>
      </div>
      <div>
        <a class="btn btn-secondary" href="/upload">Nova Análise</a>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card p-3">
          <small class="text-muted">Total de jogadores</small>
          <div class="h4 text-success">{{ total if total is defined else total_players if total_players is defined else 0 }}</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <small class="text-muted">Top risco</small>
          <div class="h5 text-danger">{{ results[0]['id'] if results is defined and results|length>0 else '-' }}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3">
          <small class="text-muted">Resumo</small>
          <div class="text-muted">Envie um CSV para obter a lista de jogadores e motivos.</div>
        </div>
      </div>
    </div>

    <div class="card p-3 mb-4">
      <form method="post" enctype="multipart/form-data" action="/upload">
        <div class="row align-items-end">
          <div class="col-md-8">
            <label class="form-label">Arquivo CSV</label>
            <input class="form-control" type="file" name="file" accept=".csv" required>
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100">Enviar e Analisar</button>
          </div>
        </div>
      </form>
    </div>

    <div class="card p-3">
      <h5 class="mb-3">Resultados</h5>
      {% if results is defined and results|length > 0 %}
        <div class="table-responsive" style="max-height: 520px; overflow: auto;">
          <table class="table table-dark table-hover table-striped mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Risk Score</th>
                <th>Avg Stake</th>
                <th>Win Rate</th>
                <th>Motivos</th>
              </tr>
            </thead>
            <tbody>
              {% for r in results %}
                <tr>
                  <td>{{ r['id'] }}</td>
                  <td class="text-danger">{{ '%.3f'|format(r['risk_score']) }}</td>
                  <td>{{ r['avg_stake']|default('-') }}</td>
                  <td>{{ r['win_rate']|default('-') }}</td>
                  <td>
                    {% for m in r['reasons'] %}
                      <span class="badge bg-secondary text-dark me-1">{{ m }}</span>
                    {% endfor %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-3 text-muted">Nenhum resultado. Faça o upload de um arquivo CSV para análise.</div>
      {% endif %}
    </div>
  </div>
{% endblock %}